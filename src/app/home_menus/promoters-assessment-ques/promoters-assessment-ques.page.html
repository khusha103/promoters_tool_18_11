<ion-header [translucent]="true" class="custom-border-header">
  <ion-toolbar class="maincontainer">
    <ion-grid>
      <ion-row class="toolbar-row">
        <ion-col size="4" class="toolbar-col">
          <a href="#" class="back_link">
            <ion-icon name="chevron-back-outline" class="back-button" [routerLink]="['/promoters-assessment']"></ion-icon>
          </a>
        </ion-col>
        <ion-col size="4" class="toolbar-col second_col_img">
          <img src="/assets/icon/homeicons/sony_light.svg" alt="" class="SONY_mail_logo dark_pta">
          <img src="/assets/icon/homeicons/sony_dark.svg" alt="" class="SONY_mail_logo light_pta">
        </ion-col>
        <ion-col size="4" class="toolbar-col"></ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>
</ion-header>

<ion-content class="main-content dark light">
  <!-- Sticky banner for unanswered items -->
  <div *ngIf="hasTriedSubmit && unansweredCount > 0" class="unanswered-banner">
    {{ unansweredCount }} question(s) need an answer. Please complete them.
  </div>

  <div *ngFor="let question of questions; let i = index"
       class="question-card margin-bottom-20"
       [ngClass]="{'unanswered': hasTriedSubmit && isUnanswered(question)}"
       #qRef>

    <h6 class="questionhead">Question {{ i + 1 }}:</h6>
    
    <!-- Display question body -->
    <p class="question-body questionpara">{{ question.body }}</p>
    
    <!-- Display image if file_name is not null -->
    <img *ngIf="question.file_name"
         [src]="baseUrl + question.file_name"
         alt="Question Image"
         class="question-image"
         (click)="openImageInBrowser(baseUrl + question.file_name)" />

    <div class="options margin-top-10">
      <ion-label class="options">Options:</ion-label>

      <!-- SCALE / Percentage (type_id === '2') -->
      <!-- FIXED: Now uses correct IDs 1,2,3,8,9 from scaleOptions array -->
      <ng-container *ngIf="(question.type_id === '2' || question.type_id === 2) && question.option_type !== '4'">
        <ion-radio-group
          [(ngModel)]="question.selectedOption"
          (ngModelChange)="onOptionChange(question, $event)">
          
          <ion-item class="transparent-item">
            <ion-label class="low-percentage">&lt;60%</ion-label>
          </ion-item>

          <!-- Use scaleOptions array with correct IDs -->
          <ion-item class="transparent-item" *ngFor="let s of question.scaleOptions">
            <ion-label>{{ s.label }}</ion-label>
            <ion-radio [value]="s.id"></ion-radio>
          </ion-item>

          <ion-item class="transparent-item">
            <ion-label class="high-percentage">&gt;90%</ion-label>
          </ion-item>
        </ion-radio-group>
      </ng-container>

      <!-- YES/NO/NA (type_id === '1') -->
      <ng-container *ngIf="(question.type_id === '1' || question.type_id === 1) && question.option_type !== '4'">
        <ion-radio-group
          [(ngModel)]="question.selectedOption"
          (ngModelChange)="onOptionChange(question, $event)">
          
          <ion-item class="transparent-item" *ngIf="question.is_na === '1' || question.is_na === 1">
            <ion-label>NA</ion-label>
            <ion-radio [value]="4"></ion-radio>
          </ion-item>

          <ion-item class="transparent-item">
            <ion-label>Yes</ion-label>
            <ion-radio [value]="5"></ion-radio>
          </ion-item>

          <ion-item class="transparent-item">
            <ion-label>No</ion-label>
            <ion-radio [value]="6"></ion-radio>
          </ion-item>
        </ion-radio-group>
      </ng-container>

      <!-- RATING (Very Bad -> Very Good) when option_type === '4' -->
      <!-- FIXED: Now uses correct IDs 10-14 from ratingOptions array -->
      <ng-container *ngIf="question.option_type === '4' || question.type_id === '4'">
        <ion-radio-group
          [(ngModel)]="question.selectedOption"
          (ngModelChange)="onOptionChange(question, $event)">
          
          <ng-container *ngFor="let r of question.ratingOptions">
            <ion-item lines="none"
                      class="match-radio-item"
                      [class.checked]="question.selectedOption === r.id">
              <ion-label class="match-radio-label">
                <div class="match-title">{{ r.label }}</div>
                <div class="match-desc" *ngIf="r.description">{{ r.description }}</div>
              </ion-label>
              <ion-radio slot="end" [value]="r.id"></ion-radio>
            </ion-item>
          </ng-container>
        </ion-radio-group>
      </ng-container>
    </div>

    <!-- Remarks input field -->
    <div class="remarks-upload-container">
      <ion-label class="options">Remarks:</ion-label>
      <ion-input type="text"
                 placeholder="Enter Remark"
                 [(ngModel)]="question.remarks"
                 class="options"></ion-input>

      <!-- Upload Image Button -->
      <ion-button class="upload-button camerabutton" fill="clear" (click)="selectImage(i)">
        <ion-icon name="camera-outline" style="color: #e66b24 !important"></ion-icon>
      </ion-button>
    </div>

    <!-- Uploaded Images Preview (multiple) -->
    <div class="image-preview-container" *ngIf="photos[i] && photos[i].length > 0">
      <div *ngFor="let photo of photos[i]; let j = index" class="image-thumbnail">
        <img [src]="photo.base64" alt="Captured Image">
        <ion-icon name="close-circle"
                  class="delete-icon"
                  (click)="removeQuestionImage(i, j)"></ion-icon>
      </div>
    </div>

    <hr />
  </div>

  <!-- Feedback textarea with camera icon inside -->
  <div class="feedback-input-wrap">
    <ion-textarea [(ngModel)]="feedback"
                  placeholder="Enter your feedback here..."
                  maxlength="500"
                  fill="outline"
                  label-placement="stacked"
                  class="custom-textarea cttextareas with-icon">
    </ion-textarea>

    <ion-icon name="camera-outline"
              class="feedback-camera inside"
              (click)="selectFeedbackImage()">
    </ion-icon>
  </div>

  <!-- Feedback Images Preview (multiple) -->
  <div class="image-preview-container" *ngIf="feedbackPhotos.length > 0">
    <div *ngFor="let photo of feedbackPhotos; let k = index" class="image-thumbnail">
      <img [src]="photo.base64" alt="Feedback Image">
      <ion-icon name="close-circle"
                class="delete-icon"
                (click)="removeFeedbackImage(k)"></ion-icon>
    </div>
  </div>

  <!-- Submit Button -->
  <div class="submit-button">
    <ion-button expand="full"
                (click)="confirmAndSubmit()"
                class="products_buttons">
      Submit Answers
    </ion-button>
  </div>
</ion-content>

<!-- Optional footer component -->
<app-footer></app-footer>